# Upstream v9.1.1 Merge Assessment (Fork Patch Reconciliation)

Date: 2026-02-08  
Fork baseline: `staging/merge-v9.0.17` (`9.0.17-jv.1`)  
Upstream target: `v9.1.1` (tag `5969d670`, 2026-02-07)

## Scope and Method

This report assesses whether fork patches documented in `docs/FORK-CHANGES.md` are now fixed upstream, then recommends how to merge to `v9.1.1`.

Checked:
- Upstream tags and commits between `v9.0.17..v9.1.1`
- Per-category feature markers in source files (fork `HEAD` vs upstream `v9.1.1`)
- Overlap/conflict risk files (changed on both sides since `v9.0.17`)

## Executive Summary

- Upstream has moved from `v9.0.17` (2026-02-05) to `v9.1.1` (2026-02-07).
- **Fully upstreamed categories**: `I` (Folder CLAUDE.md toggle/exclusions), `J` core intent (memorySessionId generation for stateless providers).
- **Partially upstreamed categories**: `A`, `H`, `O`, `Q`, `R`, `T` (only small pieces).
- **Still fork-only / should be preserved**: `P`, `D`, `E`, `K`, `L`, `M`, `N`, `S` (+ on-hold `B`, `F` if still desired).

## Category-by-Category Decision Matrix

| Category | Upstream v9.1.1 Status | Merge Decision | Evidence |
|---|---|---|---|
| `P` ConversationHistory leak | **Not fixed** | Keep fork patch | Fork has `ROLLOVER_HISTORY_CLEARED` logic in `SessionRoutes`; no equivalent in upstream `SessionRoutes`. |
| `A` Dynamic path resolution | **Partial** | Keep fork approach | Upstream added `CLAUDE_CONFIG_DIR` support (`75a0f2e9`) but still hardcodes marketplace owner in `MARKETPLACE_ROOT` (`thedotmack`). |
| `J` memorySessionId non-Claude | **Mostly fixed upstream** | Drop duplicate logic, keep provider rename mapping | Upstream commit `711f5455` generates synthetic IDs for Gemini/OpenRouter; fork OpenAI rename still needs compatible mapping. |
| `M` Context truncation | **Not equivalent** | Keep fork implementation | Upstream has OpenRouter truncation, but not fork’s shared truncation utility + Gemini/OpenAI parity + overflow retry flow. |
| `N` Claude rollover decoupling | **Not fixed** | Keep fork implementation | Upstream still uses `memorySessionId` as resume identity; no `claude_resume_session_id` / `last_input_tokens` columns or decoupled model. |
| `O` Safe message processing | **Partial** | Keep fork enhancements | Upstream has claim/processing model, but fork adds stronger orphan/timed-out reclaim behavior (`storeInitEpoch`, retry strategy). |
| `Q` Stuck recovery bugfix set | **Partial** | Keep fork enhancements, merge upstream improvements | Upstream includes provider-aware recovery (`2d40afe7`) + abort reset (`ea386015`) + restart guard, but lacks fork periodic recovery settings and full recovery orchestration. |
| `R` Idle session cleanup | **Partial** | Keep fork behavior | Upstream improves cleanup/session-complete flow, but fork staggered restart + active cleanup behavior still differs. |
| `S` Sync dotfile copy | **Not fixed for fork use case** | Keep fork patch | Upstream `sync-marketplace.cjs` uses `rsync ... --exclude=/.mcp.json`; fork needs dotfile copy for MCP config continuity. |
| `T` Exponential backoff retry | **Partial** | Keep fork implementation | Upstream adds restart backoff in crash flow, but not fork’s shared API retry utility for providers. |
| `E` Empty search params | **Not fixed** | Keep fork patch | Upstream lacks `_` exclusion in filter detection and lacks `getRecent*` fallback helpers in `SessionSearch`. |
| `D` MCP schema enhancement | **Not fixed** | Keep fork patch | Upstream `search`/`timeline` tool schemas still have empty `properties: {}`. |
| `H` Custom API endpoints | **Partial** | Keep fork implementation | Upstream includes localhost CORS hardening (`86b1d7fa`) but lacks fork base URL settings, endpoint validation, and settings API constraints. |
| `K` Dynamic model selection + OpenRouter→OpenAI | **Not fixed** | Keep fork implementation | Upstream remains `openrouter`-named provider (`OpenRouterAgent.ts`), no fork `OpenAIAgent`/model-fetch flow. |
| `L` Settings hot-reload | **Not fixed** | Keep fork implementation | Upstream has no `SettingsWatcher` integration equivalent to fork hot-reload restart orchestration. |
| `I` Folder CLAUDE.md optimization | **Fixed + extended upstream** | Prefer upstream implementation; retire fork-specific duplicate logic | Upstream now has `CLAUDE_MEM_FOLDER_CLAUDEMD_ENABLED` plus exclusion settings (`CLAUDE_MEM_EXCLUDED_PROJECTS`, `CLAUDE_MEM_FOLDER_MD_EXCLUDE`). |
| `B` Observation batching (on hold) | **Not upstreamed** | Keep only if still wanted | No upstream equivalents for fork batching settings/flow. |
| `F` Autonomous prevention (on hold) | **Not upstreamed** | Keep only if still wanted | No upstream compaction/warmup filter logic equivalent. |
| `G` Fork config/versioning | N/A | Keep/update | Required for fork identity and marketplace delivery. |

## Upstream Commits That Overlap Fork Areas

Important upstream changes to integrate (not blindly overwrite):

- `75a0f2e9`: respects `CLAUDE_CONFIG_DIR` for plugin paths
- `711f5455`: synthetic `memorySessionId` for stateless providers
- `2d40afe7`: provider-aware recovery + stale session cleanup
- `ea386015`: reset `AbortController` before restart
- `6382d6f9`: restart loop guard and backoff (session-level)
- `9907df1d` + `bf439043`: folder CLAUDE.md enable/exclude settings
- `86b1d7fa`: localhost-only CORS restriction
- `98920bd8`: `save_memory` MCP tool (coexists with fork schema patches)

## Conflict Risk (Files changed on both sides)

High-risk overlap files for merge conflicts/regressions:

- `src/shared/SettingsDefaultsManager.ts`
- `src/services/worker/http/routes/SessionRoutes.ts`
- `src/services/worker-service.ts`
- `src/services/worker/SessionManager.ts`
- `src/services/sqlite/PendingMessageStore.ts`
- `src/services/worker/GeminiAgent.ts`
- `src/servers/mcp-server.ts`
- `src/services/worker/http/routes/SettingsRoutes.ts`
- `src/utils/claude-md-utils.ts`
- `plugin/scripts/smart-install.js`
- `scripts/sync-marketplace.cjs`
- `src/shared/worker-utils.ts`
- `src/services/infrastructure/HealthMonitor.ts`
- `src/services/integrations/CursorHooksInstaller.ts`

## Recommended Merge Procedure (v9.1.1)

1. **Create integration branch from current fork branch**
   - `git checkout staging/merge-v9.0.17`
   - `git fetch upstream --tags`
   - `git checkout -b staging/merge-v9.1.1`
   - `git merge v9.1.1`

2. **Resolve with “upstream-first” only for truly upstreamed categories**
   - Prefer upstream behavior for `I` and `J` base implementation.
   - Keep fork extensions where upstream only partially overlaps (`A/H/O/Q/R/T`).

3. **Re-apply/verify fork-critical categories in this order**
   - `P` → `N` → `Q/O` (stability core)
   - `E` + `D` (MCP usability regressions)
   - `A` + `S` (fork install/runtime path integrity)
   - `H` + `K` + `L` + `M` (provider/platform features)
   - `B/F` only if still intentionally maintained

4. **Version and packaging**
   - Bump fork version in:
     - `package.json`
     - `plugin/package.json`
     - `plugin/.claude-plugin/plugin.json`
     - `.claude-plugin/marketplace.json`

5. **Build and targeted validation**
   - `npm run build`
   - Re-run category verification checks from `docs/FORK-CHANGES.md` Step 5.
   - Add focused checks for upstream-overlap regressions (`I`, `J`, `CORS`, recovery flow).

## Practical “Drop vs Keep” Cheat Sheet

- **Drop/absorb into upstream**: category `I` duplicate toggle logic, category `J` duplicate synthetic-ID code where equivalent.
- **Keep (critical)**: `P`, `N`, `Q`, `O`, `E`, `D`, `A`, `S`, `T`, `K`, `L`, `M`.
- **Keep with upstream merge blending**: `H`, `R`.
- **Optional/on-hold**: `B`, `F`.

## Suggested Follow-up

After conflict resolution, update `docs/FORK-CHANGES.md`:
- Set upstream base to `v9.1.1`.
- Mark `I` and `J` as upstream-covered (with fork-specific deltas only).
- Add a “Removed/Obsoleted by upstream” subsection to prevent re-porting dead patches in future merges.

